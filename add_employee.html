<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ajouter un employé</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="card">
    <h1>Ajouter un employé</h1>
    <label for="empName">Nom complet</label>
    <input id="empName" type="text" placeholder="Nom complet" aria-label="Nom complet" required>

    <label for="empEmail">Email</label>
    <input id="empEmail" type="email" placeholder="Email" aria-label="Email de l’employé" required>

    <label for="empPass">Mot de passe</label>
    <input id="empPass" type="password" placeholder="Mot de passe (min 8 caractères)" aria-label="Mot de passe" required>

    <label for="empShift">Shift</label>
    <select id="empShift" aria-label="Shift" required>
      <option value="">Sélectionner un shift</option>
      <option value="Matin">Matin</option>
      <option value="Soir">Soir</option>
    </select>

    <button id="saveEmployeeBtn"><i class="fas fa-save"></i> Sauvegarder</button>
    <button id="backBtn"><i class="fas fa-arrow-left"></i> Retour</button>
    <div id="loader" class="loader" style="display: none;"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>
    <div id="msg" class="msg"></div>
  </div>

  <script type="module">
    import { supabase } from './config.js';

    function showToast(message, type = 'info') {
      const msg = document.getElementById('msg');
      msg.textContent = message;
      msg.className = `msg ${type}`;
      setTimeout(() => (msg.textContent = ''), 5000);
    }

    document.getElementById('saveEmployeeBtn').addEventListener('click', async () => {
      const full_name = document.getElementById('empName').value.trim();
      const email = document.getElementById('empEmail').value.trim();
      const password = document.getElementById('empPass').value.trim();
      const shift = document.getElementById('empShift').value;

      if (!full_name || !email || !password || !shift) {
        showToast('Tous les champs sont requis.', 'error');
        return;
      }

      document.getElementById('loader').style.display = 'block';

      try {
        const { data: created, error: createErr } = await supabase.auth.admin.createUser({
          email,
          password,
          email_confirm: true,
          app_metadata: { role: "employe" },
          user_metadata: { full_name, shift },
        });
        if (createErr) throw createErr;

        const { error: employeeErr } = await supabase.from('employees').insert([{
          email,
          full_name,
          shift,
        }]);
        if (employeeErr) throw employeeErr;

        const { data: { user } } = await supabase.auth.getUser();
        await supabase.from('logs').insert({
          event: `Création employé: ${email}`,
          user_id: user.id,
        });

        showToast('Employé ajouté avec succès !', 'success');
        setTimeout(() => window.location.href = 'admin.html', 2000);
      } catch (e) {
        showToast(`Erreur : ${e.message}`, 'error');
        console.error('Add employee error:', e);
      } finally {
        document.getElementById('loader').style.display = 'none';
      }
    });

    document.getElementById('backBtn').addEventListener('click', () => {
      window.location.href = 'admin.html';
    });
  </script>
</body>
</html>
