<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de bord Admin</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsPDF/1.5.3/jsPDF.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
</head>
<body>
  <div class="card">
    <h1>Tableau de bord Admin</h1>
    <button id="logoutBtn" aria-label="Déconnexion"><i class="fas fa-sign-out-alt"></i> Déconnexion</button>

    <h2>Ajouter un employé</h2>
    <button id="addEmployeeBtn"><i class="fas fa-user-plus"></i> Ajouter un employé</button>

    <h2>QR Code</h2>
    <canvas id="qrcode"></canvas>
    <button id="downloadQrPdfBtn"><i class="fas fa-download"></i> Télécharger QR en PDF</button>

    <h2>Dossier employés</h2>
    <table id="employeesTable">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Email</th>
          <th>Shift</th>
          <th>Selfies</th>
          <th>Congé</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2>Historique des pointages</h2>
    <label for="filterEmployee">Filtrer par email</label>
    <input id="filterEmployee" type="text" placeholder="Filtrer par email" aria-label="Filtrer par email">
    <label for="filterDate">Filtrer par date</label>
    <input id="filterDate" type="date" aria-label="Filtrer par date">
    <button id="filterBtn"><i class="fas fa-filter"></i> Filtrer</button>
    <div class="pagination">
      <button id="prevPageBtn" disabled><i class="fas fa-chevron-left"></i> Précédent</button>
      <button id="nextPageBtn"><i class="fas fa-chevron-right"></i> Suivant</button>
    </div>
    <button id="exportCsvBtn"><i class="fas fa-file-csv"></i> Exporter CSV</button>
    <table id="pointagesTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Employé</th>
          <th>Selfie</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2>Statistiques</h2>
    <button id="statsBtn"><i class="fas fa-chart-bar"></i> Voir Statistiques</button>
    <canvas id="statsChart"></canvas>

    <h2>Selfies par jour</h2>
    <button id="selfiesBtn"><i class="fas fa-camera"></i> Voir Selfies</button>
    <div id="selfies"></div>

    <h2>Logs d’audit</h2>
    <button id="logsBtn"><i class="fas fa-history"></i> Voir Logs</button>
    <table id="logsTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Événement</th>
          <th>Utilisateur</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Modale pour changer le shift -->
  <div id="shiftModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h3>Changer le shift</h3>
      <select id="newShift">
        <option value="Matin">Matin</option>
        <option value="Soir">Soir</option>
      </select>
      <button id="saveShiftBtn"><i class="fas fa-save"></i> Sauvegarder</button>
      <button id="closeShiftModalBtn"><i class="fas fa-times"></i> Fermer</button>
    </div>
  </div>

  <!-- Modale pour voir les selfies -->
  <div id="selfieModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h3>Selfies de l'employé</h3>
      <div id="selfieList"></div>
      <button id="closeSelfieModalBtn"><i class="fas fa-times"></i> Fermer</button>
    </div>
  </div>

  <script type="module">
    import { supabase } from './config.js';
    import QRCode from 'https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js';

    let page = 1;
    const perPage = 10;
    let chart = null;
    let selectedEmployeeId = null;

    function showToast(message, type = 'info') {
      const msg = document.getElementById('empMsg');
      msg.textContent = message;
      msg.className = `msg ${type}`;
      setTimeout(() => (msg.textContent = ''), 3000);
    }

    async function loadEmployees() {
      const { data, error } = await supabase.from('employees').select('*');
      if (error) {
        showToast('Erreur lors du chargement des employés.', 'error');
        return;
      }
      const tbody = document.querySelector('#employeesTable tbody');
      tbody.innerHTML = '';
      data.forEach(emp => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${emp.full_name}</td>
          <td>${emp.email}</td>
          <td><span class="editable-shift" data-id="${emp.id}" style="cursor: pointer;">${emp.shift}</span></td>
          <td><button class="view-selfies" data-id="${emp.id}" aria-label="Voir selfies de ${emp.full_name}"><i class="fas fa-camera"></i></button></td>
          <td><button class="toggle-conge" data-id="${emp.id}" aria-label="Prendre congé pour ${emp.full_name}"><i class="fas fa-calendar-times"></i></button></td>
          <td><button onclick="deleteEmployee(${emp.id})" aria-label="Supprimer ${emp.full_name}"><i class="fas fa-trash"></i></button></td>
        `;
        tbody.appendChild(tr);
      });
      // Ajouter les écouteurs pour changer le shift
      document.querySelectorAll('.editable-shift').forEach(span => {
        span.addEventListener('click', (e) => {
          selectedEmployeeId = e.target.dataset.id;
          document.getElementById('shiftModal').style.display = 'block';
        });
      });
      // Ajouter les écouteurs pour voir les selfies
      document.querySelectorAll('.view-selfies').forEach(btn => {
        btn.addEventListener('click', (e) => {
          selectedEmployeeId = e.target.dataset.id;
          loadEmployeeSelfies(selectedEmployeeId);
          document.getElementById('selfieModal').style.display = 'block';
        });
      });
      // Ajouter les écouteurs pour prendre congé
      document.querySelectorAll('.toggle-conge').forEach(btn => {
        btn.addEventListener('click', (e) => {
          selectedEmployeeId = e.target.dataset.id;
          toggleConge(selectedEmployeeId);
        });
      });
    }

    async function toggleConge(id) {
      const { data: current, error: fetchError } = await supabase
        .from('employees')
        .select('conge')
        .eq('id', id)
        .single();
      if (fetchError) {
        showToast('Erreur lors du chargement du statut de congé.', 'error');
        return;
      }

      const newConge = !current.conge;
      const { error } = await supabase
        .from('employees')
        .update({ conge: newConge })
        .eq('id', id);
      if (error) {
        showToast('Erreur lors de la mise à jour du congé.', 'error');
      } else {
        showToast(`Congé ${newConge ? 'activé' : 'désactivé'}.`, 'success');
        loadEmployees();
      }
    }

    async function loadEmployeeSelfies(id) {
      const { data, error } = await supabase
        .from('pointages')
        .select('timestamp, selfie_url')
        .eq('employee_id', id)
        .order('timestamp', { ascending: false });
      if (error) {
        showToast('Erreur lors du chargement des selfies.', 'error');
        return;
      }
      const selfieList = document.getElementById('selfieList');
      selfieList.innerHTML = '';
      data.forEach(p => {
        const div = document.createElement('div');
        div.innerHTML = `<p>${new Date(p.timestamp).toLocaleString()}</p><img src="${p.selfie_url}" alt="Selfie" style="width: 100px;">`;
        selfieList.appendChild(div);
      });
    }

    async function saveNewShift() {
      const newShift = document.getElementById('newShift').value;
      if (!selectedEmployeeId) return;

      const { error } = await supabase
        .from('employees')
        .update({ shift: newShift })
        .eq('id', selectedEmployeeId);
      if (error) {
        showToast('Erreur lors de la mise à jour du shift.', 'error');
      } else {
        showToast('Shift mis à jour.', 'success');
        loadEmployees();
        document.getElementById('shiftModal').style.display = 'none';
      }
    }

    document.getElementById('saveShiftBtn').addEventListener('click', saveNewShift);
    document.getElementById('closeShiftModalBtn').addEventListener('click', () => {
      document.getElementById('shiftModal').style.display = 'none';
    });

    document.getElementById('closeSelfieModalBtn').addEventListener('click', () => {
      document.getElementById('selfieModal').style.display = 'none';
    });

    document.getElementById('addEmployeeBtn').addEventListener('click', () => {
      window.location.href = 'add_employee.html';
    });

    // Le reste du code reste inchangé, avec les fonctions pour loadPointages, loadStats, loadSelfies, loadLogs, etc.
    // ... (ajoute le code précédent ici pour les autres fonctionnalités)

    // Vérification de la session
    supabase.auth.getUser().then(async ({ data: { user } }) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      const { data: profile } = await supabase.from('profiles').select('role').eq('id', user.id).single();
      if (profile?.role !== 'admin') {
        window.location.href = 'employe.html';
      } else {
        loadEmployees();
        loadPointages();
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      const { error } = await supabase.auth.signOut();
      if (error) {
        showToast(`Erreur déconnexion : ${error.message}`, 'error');
      } else {
        showToast('Déconnecté.', 'success');
        window.location.href = 'index.html';
      }
    });

    // Télécharger QR en PDF
    document.getElementById('downloadQrPdfBtn').addEventListener('click', () => {
      const pdf = new jsPDF();
      pdf.addImage(document.getElementById('qrcode').toDataURL('image/png'), 'PNG', 10, 10, 180, 160);
      pdf.save('qr_code.pdf');
    });
  </script>
</body>
</html>
